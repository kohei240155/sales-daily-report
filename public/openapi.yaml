openapi: 3.0.3
info:
  title: 営業日報システム API
  description: |
    営業担当者が日々の営業活動を報告し、上長が確認・フィードバックできる日報管理システムのAPI仕様。

    ## 認証方式
    JWT（JSON Web Token）を使用したBearer認証

    ## 主な機能
    - 日報の作成・編集・削除・閲覧
    - 訪問記録の管理
    - 上長からのコメント機能
    - 顧客マスタ管理
    - 営業担当者マスタ管理
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://api.example.com/v1
    description: 本番環境
  - url: http://localhost:3000/api/v1
    description: ローカル開発環境

tags:
  - name: auth
    description: 認証関連
  - name: daily-reports
    description: 日報管理
  - name: visit-records
    description: 訪問記録管理
  - name: comments
    description: コメント管理
  - name: customers
    description: 顧客マスタ管理
  - name: sales
    description: 営業担当者マスタ管理

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWTトークンによる認証

  schemas:
    # 共通スキーマ
    SuccessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success]
        data:
          type: object
      required:
        - status
        - data

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          enum: [error]
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string
      required:
        - status
        - error

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total_count:
          type: integer
          example: 100
        total_pages:
          type: integer
          example: 5

    # エンティティスキーマ
    Sales:
      type: object
      properties:
        sales_id:
          type: integer
          example: 1
        sales_name:
          type: string
          maxLength: 100
          example: 山田太郎
        email:
          type: string
          format: email
          example: yamada@example.com
        department:
          type: string
          maxLength: 100
          example: 営業部
        position:
          type: string
          maxLength: 50
          example: 課長
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Customer:
      type: object
      properties:
        customer_id:
          type: integer
          example: 1
        customer_name:
          type: string
          maxLength: 100
          example: 佐藤一郎
        company_name:
          type: string
          maxLength: 200
          example: 株式会社ABC
        phone:
          type: string
          maxLength: 20
          example: 03-1234-5678
        email:
          type: string
          format: email
          example: sato@abc.co.jp
        address:
          type: string
          maxLength: 500
          example: 東京都千代田区丸の内1-1-1
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    DailyReport:
      type: object
      properties:
        report_id:
          type: integer
          example: 1
        sales_id:
          type: integer
          example: 1
        sales_name:
          type: string
          example: 山田太郎
        department:
          type: string
          example: 営業部
        report_date:
          type: string
          format: date
          example: '2026-01-02'
        problem:
          type: string
          maxLength: 2000
          example: 新規顧客の開拓が思うように進んでいない
        plan:
          type: string
          maxLength: 2000
          example: 既存顧客へのフォローアップと紹介依頼を実施
        visit_records:
          type: array
          items:
            $ref: '#/components/schemas/VisitRecord'
        comments:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    VisitRecord:
      type: object
      properties:
        visit_id:
          type: integer
          example: 1
        report_id:
          type: integer
          example: 1
        customer_id:
          type: integer
          example: 10
        customer_name:
          type: string
          example: 佐藤一郎
        company_name:
          type: string
          example: 株式会社ABC
        visit_time:
          type: string
          pattern: '^\d{2}:\d{2}$'
          example: '10:00'
        visit_content:
          type: string
          maxLength: 1000
          example: 新商品の提案を実施。前向きな反応あり
        created_at:
          type: string
          format: date-time

    Comment:
      type: object
      properties:
        comment_id:
          type: integer
          example: 1
        report_id:
          type: integer
          example: 1
        sales_id:
          type: integer
          example: 5
        sales_name:
          type: string
          example: 田中部長
        comment_content:
          type: string
          maxLength: 1000
          example: 新規開拓については来週ミーティングで相談しましょう
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # リクエストボディスキーマ
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: yamada@example.com
        password:
          type: string
          format: password
          example: password123

    CreateDailyReportRequest:
      type: object
      required:
        - report_date
        - visit_records
      properties:
        report_date:
          type: string
          format: date
          example: '2026-01-02'
        problem:
          type: string
          maxLength: 2000
        plan:
          type: string
          maxLength: 2000
        visit_records:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - customer_id
              - visit_content
            properties:
              customer_id:
                type: integer
              visit_time:
                type: string
                pattern: '^\d{2}:\d{2}$'
              visit_content:
                type: string
                maxLength: 1000

    CreateCommentRequest:
      type: object
      required:
        - comment_content
      properties:
        comment_content:
          type: string
          maxLength: 1000

    CreateCustomerRequest:
      type: object
      required:
        - customer_name
        - company_name
      properties:
        customer_name:
          type: string
          maxLength: 100
        company_name:
          type: string
          maxLength: 200
        phone:
          type: string
          maxLength: 20
        email:
          type: string
          format: email
        address:
          type: string
          maxLength: 500

paths:
  # 認証API
  /auth/login:
    post:
      tags:
        - auth
      summary: ログイン
      description: メールアドレスとパスワードでログインし、JWTトークンを取得
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          token:
                            type: string
                            example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                          expires_in:
                            type: integer
                            example: 86400
                          user:
                            $ref: '#/components/schemas/Sales'
        '401':
          description: 認証失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - auth
      summary: ログアウト
      description: 現在のトークンを無効化
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ログアウト成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  # 日報API
  /daily-reports:
    get:
      tags:
        - daily-reports
      summary: 日報一覧取得
      description: 日報の一覧を取得（検索・フィルタリング可能）
      operationId: getDailyReports
      security:
        - bearerAuth: []
      parameters:
        - name: sales_id
          in: query
          description: 営業担当者ID
          schema:
            type: integer
        - name: start_date
          in: query
          description: 開始日（YYYY-MM-DD）
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          description: 終了日（YYYY-MM-DD）
          schema:
            type: string
            format: date
        - name: page
          in: query
          description: ページ番号
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          description: 1ページあたりの件数
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/DailyReport'
                          pagination:
                            $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - daily-reports
      summary: 日報作成
      description: 新しい日報を作成
      operationId: createDailyReport
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDailyReportRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DailyReport'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 同一日付の日報が既に存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /daily-reports/{report_id}:
    get:
      tags:
        - daily-reports
      summary: 日報詳細取得
      description: 指定した日報の詳細情報を取得
      operationId: getDailyReportById
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: 日報ID
          schema:
            type: integer
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DailyReport'
        '404':
          description: 日報が存在しない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - daily-reports
      summary: 日報更新
      description: 既存の日報を更新
      operationId: updateDailyReport
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: 日報ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDailyReportRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DailyReport'
        '403':
          description: 権限なし（本人以外）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - daily-reports
      summary: 日報削除
      description: 指定した日報を削除
      operationId: deleteDailyReport
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: 日報ID
          schema:
            type: integer
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  # コメントAPI
  /daily-reports/{report_id}/comments:
    get:
      tags:
        - comments
      summary: コメント一覧取得
      description: 指定した日報のコメント一覧を取得
      operationId: getComments
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: 日報ID
          schema:
            type: integer
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Comment'

    post:
      tags:
        - comments
      summary: コメント作成
      description: 日報にコメントを追加（上長のみ）
      operationId: createComment
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: 日報ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCommentRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Comment'
        '403':
          description: 権限なし（上長のみ）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 顧客マスタAPI
  /customers:
    get:
      tags:
        - customers
      summary: 顧客一覧取得
      description: 顧客マスタの一覧を取得
      operationId: getCustomers
      security:
        - bearerAuth: []
      parameters:
        - name: customer_name
          in: query
          description: 顧客名（部分一致）
          schema:
            type: string
        - name: company_name
          in: query
          description: 会社名（部分一致）
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Customer'
                          pagination:
                            $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - customers
      summary: 顧客作成
      description: 新しい顧客を登録（管理者のみ）
      operationId: createCustomer
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Customer'
        '403':
          description: 権限なし（管理者のみ）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
